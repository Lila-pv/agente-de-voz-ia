<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- T칤tulo solicitado: Agente de IA con Voz y Texto -->
    <title>Agente de IA con Voz y Texto</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Estilo para que el texto pre-formateado mantenga saltos de l칤nea */
        #responseOutput {
            white-space: pre-wrap; 
            word-break: break-word; /* Asegura que las URLs largas no rompan el layout */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">
    <div class="max-w-3xl mx-auto bg-white p-6 rounded-xl shadow-2xl border border-gray-100">
        <!-- T칤tulo Principal y Icono -->
        <h1 class="text-3xl font-extrabold mb-2 text-indigo-700 flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot mr-3 text-emerald-500"><path d="M12 8V4H8"/><path d="M2 13V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2z"/><path d="M10 9h4"/><path d="M8 17h8"/><path d="M20 9H4"/></svg>
            Agente de IA con Voz y Texto
        </h1>
        <p class="text-sm text-gray-500 mb-6">Modelo: Gemini Flash (v칤a Proxy Seguro). La funcionalidad de voz puede implementarse en esta misma interfaz.</p>
        
        <!-- 츼rea de Input para el Prompt -->
        <div class="mb-6">
            <label for="prompt" class="block text-md font-semibold text-gray-700 mb-2">
                Escribe tu consulta:
            </label>
            <textarea id="prompt" rows="4" 
                      class="mt-1 block w-full rounded-xl border border-gray-300 shadow-inner focus:border-indigo-600 focus:ring-indigo-600 p-4 text-gray-800 transition duration-150 resize-none" 
                      placeholder="Ej: 쯈u칠 est치 pasando con las noticias de tecnolog칤a hoy?"></textarea>
        </div>

        <!-- Controles de Interacci칩n -->
        <div class="flex space-x-4 mb-8">
            <button id="sendButton" 
                    class="flex-1 py-3 px-4 border border-transparent rounded-xl shadow-lg text-white font-bold bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-indigo-500 transition duration-200 ease-in-out transform hover:scale-[1.01] disabled:bg-indigo-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send inline-block mr-2"><path d="m22 2-7 14-5-5-14-7z"/><path d="M22 2 11 13"/></svg>
                Enviar Texto
            </button>
            
            <!-- Bot칩n para futura funci칩n de Voz (actualmente desactivado) -->
            <button id="voiceButton" disabled
                    class="flex-none py-3 px-4 border border-transparent rounded-xl shadow-lg text-white font-bold bg-emerald-500 opacity-50 cursor-not-allowed">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mic-vocal inline-block"><path d="m12 11-1 9-2-5-5-2-9-1 9 1 5 2 2 5 1-9-1-9 1-9"/><path d="m12 11 1 9 2-5 5-2 9-1-9 1-5 2-2 5-1-9 1-9 1-9"/></svg>
            </button>
        </div>

        <!-- Indicador de Carga -->
        <div id="loading" class="mt-4 hidden text-center text-indigo-600 font-bold text-lg p-2 rounded-lg bg-indigo-50 animate-pulse">
            <span class="inline-block mr-2">...</span> Pensando y buscando informaci칩n...
        </div>

        <!-- 츼rea de Output para la Respuesta -->
        <div class="mt-8">
            <h2 class="text-xl font-extrabold border-b-2 border-indigo-200 pb-2 mb-4 text-gray-800 flex justify-between items-center">
                Respuesta del Agente
                <span id="status" class="text-xs font-medium text-gray-400"></span>
            </h2>
            <div id="responseOutput" class="p-4 bg-gray-100 rounded-xl border border-gray-200 text-gray-800 text-sm min-h-[150px] leading-relaxed shadow-inner transition duration-300">
                Aqu칤 aparecer치 el texto generado por la IA, junto con las fuentes si se utiliza Google Search.
            </div>
        </div>
    </div>

    <script>
        const sendButton = document.getElementById('sendButton');
        const promptInput = document.getElementById('prompt');
        const responseOutput = document.getElementById('responseOutput');
        const loadingIndicator = document.getElementById('loading');
        const statusDisplay = document.getElementById('status');
        
        // La URL del endpoint de tu funci칩n proxy.
        const PROXY_URL = '/api/gemini-proxy'; 
        
        async function fetchGeminiResponse() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                responseOutput.textContent = "Por favor, ingresa una pregunta o comando para comenzar.";
                return;
            }

            // 1. UI Feedback: Deshabilitar bot칩n y mostrar carga
            loadingIndicator.classList.remove('hidden');
            sendButton.disabled = true;
            responseOutput.textContent = 'Generando...';
            statusDisplay.textContent = 'Solicitud en curso...';

            try {
                // El cliente llama a la URL del proxy para mantener la clave API segura
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        prompt: prompt,
                        // Le damos al modelo una personalidad de "Agente"
                        systemInstruction: "Act칰a como un Agente de IA amigable y conciso, utilizando lenguaje profesional y verificando los datos con las herramientas disponibles.",
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    // Manejar errores devueltos por la funci칩n proxy
                    statusDisplay.textContent = 'Error';
                    responseOutput.textContent = `[ERROR del Servidor Proxy]\nDetalles: ${JSON.stringify(result.details || result, null, 2)}`;
                    return;
                }

                // 2. Procesar la respuesta exitosa
                statusDisplay.textContent = 'Completo';
                const candidate = result.candidates[0];
                const generatedText = candidate.content.parts[0].text;
                
                // 3. Extraer y formatear fuentes (grounding attributions)
                let sourcesText = '';
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sourcesText = '\n\n---\n游깷 Fuentes consultadas:\n';
                    groundingMetadata.groundingAttributions.forEach((attr, index) => {
                        if (attr.web && attr.web.uri) {
                            sourcesText += `[${index + 1}] ${attr.web.title || 'Enlace sin t칤tulo'}: ${attr.web.uri}\n`;
                        }
                    });
                }
                
                responseOutput.textContent = generatedText + sourcesText;

            } catch (error) {
                // Manejar errores de red o del cliente
                console.error('Error de conexi칩n en el cliente:', error);
                statusDisplay.textContent = 'Error de Conexi칩n';
                responseOutput.textContent = 'Ocurri칩 un error de red. Verifica que la funci칩n proxy est칠 desplegada y accesible en ' + PROXY_URL;
            } finally {
                // 4. Restaurar la UI
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
            }
        }

        sendButton.addEventListener('click', fetchGeminiResponse);
    </script>
</body>
</html>