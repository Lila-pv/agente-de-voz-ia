<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Voz Gemini con TTS</title>
    <!-- Carga de Tailwind CSS para un dise帽o moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados para el tema oscuro y la animaci贸n de carga */
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .card { background-color: #161b22; border: 1px solid #30363d; }
        .btn-primary { 
            background-color: #238636; 
            border-color: #238636; 
            transition: all 0.2s;
        }
        .btn-primary:hover:not(:disabled) { background-color: #2ea043; box-shadow: 0 4px 6px rgba(46, 160, 67, 0.2); }
        .btn-primary:disabled { 
            opacity: 0.6; 
            cursor: not-allowed; 
            background-color: #238636;
        }

        /* Animaci贸n de los puntos de carga */
        .loading-dot {
            animation: bounce 0.6s infinite alternate;
            background-color: #58a6ff;
            width: 8px; height: 8px; border-radius: 50%;
            margin: 0 4px;
        }
        .loading-dot:nth-child(2) { animation-delay: 0.2s; }
        .loading-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            to { transform: translateY(-10px); }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#58a6ff',
                        'success': '#238636',
                        'danger': '#f85149',
                        'background': '#0d1117',
                        'surface': '#161b22',
                    }
                }
            }
        }
    </script>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div id="app" class="w-full max-w-lg">
        <div class="card p-6 rounded-xl shadow-2xl">
            <h1 class="text-2xl font-bold mb-4 text-primary text-center">Asistente de Voz Gemini</h1>

            <!-- rea de Entrada de Usuario -->
            <div class="flex flex-col gap-3 mb-6">
                <textarea id="userInput" class="w-full p-3 rounded-lg bg-surface border border-[#30363d] focus:border-primary focus:ring-1 focus:ring-primary transition resize-none h-24" placeholder="Haz tu pregunta (ej: '驴Qu茅 es IP?')"></textarea>
                <button id="sendButton" class="btn-primary py-2 px-4 rounded-lg font-semibold shadow-md transition duration-200 flex items-center justify-center">
                    Enviar Consulta
                </button>
            </div>

            <!-- rea de Respuesta -->
            <div id="responseContainer" class="p-4 card rounded-lg min-h-[100px] flex flex-col justify-center">
                <p id="responseText" class="text-sm italic text-gray-400">La respuesta del Asistente aparecer谩 aqu铆.</p>
                
                <div id="loadingIndicator" class="hidden flex justify-center items-center py-4">
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                    <div class="loading-dot"></div>
                </div>

                <!-- Controles TTS -->
                <div id="ttsControls" class="mt-3 hidden flex justify-between items-center">
                    <span id="ttsStatus" class="text-xs text-gray-500"></span>
                    <button id="ttsButton" class="bg-primary/20 text-primary hover:bg-primary/30 py-1 px-3 rounded-lg text-sm font-semibold transition duration-200 flex items-center disabled:opacity-50">
                        <!-- Icono de altavoz (Lucide) -->
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM12 4.5a.75.75 0 0 1 .75.75v14.5a.75.75 0 0 1-1.5 0V5.25a.75.75 0 0 1 .75-.75zM8.464 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM4.929 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75zM19.071 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75z"></path></svg>
                        Leer Respuesta
                    </button>
                </div>
            </div>

            <!-- rea de Debugging y Errores -->
            <div id="debugArea" class="mt-4 p-3 bg-danger/20 border border-danger rounded-lg text-xs hidden">
                <h3 class="font-bold text-danger mb-1">Error:</h3>
                <p id="errorMessage" class="text-danger"></p>
            </div>

        </div>
    </div>

    <script>
        // URLs y Configuraci贸n de la API
        const API_KEY = ""; 
        const TEXT_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const TTS_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent";
        const TTS_VOICE = "Kore"; // Voz firme y clara para el asistente
        const MAX_RETRIES = 5; 
        
        // Elementos del DOM
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const responseText = document.getElementById('responseText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const debugArea = document.getElementById('debugArea');
        const errorMessage = document.getElementById('errorMessage');
        const ttsControls = document.getElementById('ttsControls');
        const ttsButton = document.getElementById('ttsButton');
        const ttsStatus = document.getElementById('ttsStatus');

        // --- Funciones de Utilidad para Audio (PCM a WAV) ---

        /**
         * Convierte una cadena base64 en un ArrayBuffer.
         * @param {string} base64 - Cadena base64 de datos de audio.
         * @returns {ArrayBuffer}
         */
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Crea el encabezado WAV y convierte los datos PCM en un Blob WAV.
         * La API devuelve PCM de 16 bits firmado.
         * @param {Int16Array} pcm16 - Datos de audio PCM (16-bit, signed).
         * @param {number} sampleRate - Tasa de muestreo (ej: 24000).
         * @returns {Blob} El Blob de audio WAV.
         */
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitDepth = 16;
            const blockAlign = numChannels * (bitDepth / 8);
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * 2; // 2 bytes por Int16

            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            let offset = 0;
            const writeString = (str) => {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            };
            const writeUint32 = (val) => { view.setUint32(offset, val, true); offset += 4; };
            const writeUint16 = (val) => { view.setUint16(offset, val, true); offset += 2; };

            // RIFF chunk
            writeString('RIFF');
            writeUint32(36 + dataSize); // ChunkSize
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            writeUint32(16);          // Subchunk1Size (16 for PCM)
            writeUint16(1);           // AudioFormat (1 for PCM)
            writeUint16(numChannels); // NumChannels
            writeUint32(sampleRate);  // SampleRate
            writeUint32(byteRate);    // ByteRate
            writeUint16(blockAlign);  // BlockAlign
            writeUint16(bitDepth);    // BitsPerSample

            // data chunk
            writeString('data');
            writeUint32(dataSize);    // Subchunk2Size

            // Escribir datos PCM (Int16 a bytes)
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true); // true = little-endian
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        // --- L贸gica Principal del Asistente ---

        /**
         * Actualiza la interfaz de usuario con el estado actual.
         */
        function updateUI(state, content = '') {
            sendButton.disabled = state === 'loading';
            sendButton.textContent = state === 'loading' ? 'Procesando...' : 'Enviar Consulta';
            loadingIndicator.classList.toggle('hidden', state === 'loading');
            
            // Gestionar la visibilidad de los controles TTS
            ttsControls.classList.toggle('hidden', state !== 'ready');
            ttsButton.disabled = state !== 'ready';
            ttsStatus.textContent = ''; // Limpiar estado TTS

            // Limpiar errores
            debugArea.classList.add('hidden');
            errorMessage.textContent = '';
            responseText.classList.remove('text-danger', 'text-sm', 'italic');
            responseText.classList.add('text-lg', 'text-white', 'font-normal');
            
            if (state === 'ready') {
                responseText.innerHTML = content;
                ttsButton.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM12 4.5a.75.75 0 0 1 .75.75v14.5a.75.75 0 0 1-1.5 0V5.25a.75.75 0 0 1 .75-.75zM8.464 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM4.929 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75zM19.071 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75z"></path></svg> Leer Respuesta`;
            } else if (state === 'error') {
                debugArea.classList.remove('hidden');
                errorMessage.textContent = content;
                responseText.textContent = 'Lo siento, no pude procesar tu solicitud.';
                responseText.classList.add('text-danger');
            } else if (state === 'initial') {
                responseText.textContent = 'La respuesta del Asistente aparecer谩 aqu铆.';
                responseText.classList.add('text-sm', 'italic');
                responseText.classList.remove('text-lg', 'text-white', 'font-normal');
            }
        }

        /**
         * Llama a la API de generaci贸n de texto (Gemini) con reintentos.
         */
        async function handleQuery() {
            const userQuery = userInput.value.trim();
            if (!userQuery) {
                updateUI('error', 'Por favor, introduce una pregunta.');
                return;
            }
            
            // Diagn贸stico Cr铆tico de Clave
            if (!API_KEY) {
                updateUI('error', 'Error 403 de Configuraci贸n: La clave de API (API_KEY) no est谩 disponible. Este es un problema de inicializaci贸n del entorno que debe ser resuelto por el sistema.');
                return;
            }

            updateUI('loading');

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: "Act煤a como un asistente de voz amigable y conciso, respondiendo en espa帽ol. Elimina el formato markdown y responde solo con texto plano para facilitar la lectura de voz." }]
                },
            };
            
            const apiUrlWithKey = `${TEXT_API_URL}?key=${API_KEY}`;
            let response = null;
            let lastError = null;

            // L贸gica de Reintento Exponencial (maneja 403 y 429)
            for (let i = 0; i < MAX_RETRIES; i++) {
                try {
                    if (i > 0) {
                        const delay = Math.pow(2, i) * 1000; 
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }

                    const fetchResponse = await fetch(apiUrlWithKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    response = await fetchResponse.json();

                    if (fetchResponse.ok) {
                        break;
                    } 
                    
                    if (fetchResponse.status === 403 || fetchResponse.status === 429) {
                        lastError = `Error HTTP ${fetchResponse.status} (Reintentando...): ${response.error?.message || 'Error de API desconocido.'}`;
                    } else {
                        lastError = `Error HTTP ${fetchResponse.status} (Fallo fatal): ${response.error?.message || 'Error de API desconocido.'}`;
                        throw new Error(lastError); 
                    }

                } catch (error) {
                    lastError = `Fallo en la conexi贸n o error fatal: ${error.message}`;
                }

                if (i === MAX_RETRIES - 1) {
                    updateUI('error', `Error Final despu茅s de ${MAX_RETRIES} intentos: ${lastError}`);
                    return;
                }
            }

            // 3. Procesamiento y Renderizaci贸n de la respuesta
            const candidate = response.candidates?.[0];
            let generatedText = candidate?.content?.parts?.[0]?.text || "No se pudo generar una respuesta.";
            
            // Limpiar texto para una buena lectura (quitar Markdown)
            const cleanText = generatedText.replace(/[\*\_\#]/g, '').trim(); 
            ttsButton.setAttribute('data-text', cleanText); // Guardar el texto limpio para la voz

            // Extracci贸n de citaciones
            let sourcesHTML = '';
            const groundingMetadata = candidate?.groundingMetadata;
            if (groundingMetadata?.groundingAttributions) {
                const sources = groundingMetadata.groundingAttributions
                    .map(attr => ({
                        uri: attr.web?.uri,
                        title: attr.web?.title,
                    }))
                    .filter(source => source.uri && source.title);

                if (sources.length > 0) {
                    sourcesHTML = '<p class="text-xs text-gray-500 mt-2">Fuentes:</p>';
                    sources.forEach((source) => {
                        sourcesHTML += `<p class="text-xs text-gray-500 ml-2"> <a href="${source.uri}" target="_blank" class="hover:text-primary transition duration-150">${source.title}</a></p>`;
                    });
                }
            }

            updateUI('ready', generatedText + sourcesHTML);
        }

        /**
         * Llama a la API de TTS y reproduce el audio.
         * @param {string} textToSpeak - El texto a convertir a voz.
         */
        async function speakText(textToSpeak) {
            ttsButton.disabled = true;
            ttsStatus.textContent = 'Generando audio...';
            ttsButton.innerHTML = '<span class="animate-spin mr-1"></span> Cargando...';

            const ttsPayload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: TTS_VOICE }
                        },
                        languageCode: "es-US" // For Spanish TTS
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            const apiUrlWithKey = `${TTS_API_URL}?key=${API_KEY}`;

            try {
                const response = await fetch(apiUrlWithKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ttsPayload)
                });
                
                if (!response.ok) {
                    throw new Error(`Fallo HTTP: ${response.status}`);
                }

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    // Extraer sample rate del mimetype (ej: audio/L16;rate=24000)
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 24000; 

                    ttsStatus.textContent = 'Reproduciendo...';
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    // Los datos son PCM 16-bit signed
                    const pcm16 = new Int16Array(pcmData); 
                    
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();

                    audio.onended = () => {
                        ttsStatus.textContent = 'Reproducci贸n finalizada.';
                        ttsButton.disabled = false;
                        ttsButton.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM12 4.5a.75.75 0 0 1 .75.75v14.5a.75.75 0 0 1-1.5 0V5.25a.75.75 0 0 1 .75-.75zM8.464 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM4.929 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75zM19.071 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75z"></path></svg> Leer Respuesta';
                    };
                } else {
                    throw new Error('No se recibi贸 audio v谩lido.');
                }
            } catch (error) {
                console.error("Error TTS:", error);
                ttsStatus.textContent = 'Error al generar voz.';
                ttsButton.disabled = false;
                ttsButton.innerHTML = '<svg class="w-4 h-4 mr-1 text-danger" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM12 4.5a.75.75 0 0 1 .75.75v14.5a.75.75 0 0 1-1.5 0V5.25a.75.75 0 0 1 .75-.75zM8.464 8.464a.75.75 0 0 1 .75.75v5.5a.75.75 0 0 1-1.5 0v-5.5a.75.75 0 0 1 .75-.75zM4.929 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75zM19.071 12a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75z"></path></svg> Error Voz';
            }
        }


        // Inicializar la UI y adjuntar eventos
        window.onload = () => {
            updateUI('initial');
            sendButton.addEventListener('click', handleQuery);
            ttsButton.addEventListener('click', () => {
                const text = ttsButton.getAttribute('data-text');
                if (text) {
                    speakText(text);
                }
            });
            userInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleQuery();
                }
            });
            userInput.value = "驴Qu茅 es una direcci贸n IP y para qu茅 sirve?"; 
        };
    </script>
</body>
</html>